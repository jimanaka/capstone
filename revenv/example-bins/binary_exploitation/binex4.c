#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <sys/types.h>
#include <wchar.h>
#include <locale.h>


#define BUFSIZE 32
#define FLAGSIZE 64
#define CANARY_SIZE 4

void flag() {
  char buf[FLAGSIZE];
  FILE *f = fopen("flag.txt","r");
  if (f == NULL) {
    printf("Flag File is Missing.\n");
    exit(0);
  }

  fgets(buf,FLAGSIZE,f);
  puts(buf);
  fflush(stdout);
}

char global_canary[CANARY_SIZE];
void read_canary() {
  FILE *f = fopen("canary.txt","r");
  if (f == NULL) {
    printf("Canary is Missing.\n");
    exit(0);
  }

  fread(global_canary,sizeof(char),CANARY_SIZE,f);
  fclose(f);
}

void vuln(){
   char canary[CANARY_SIZE];
   char buf[BUFSIZE];

   memcpy(canary,global_canary,CANARY_SIZE);
   int play_length = 64;
   read(0,buf,play_length);

   if (memcmp(canary,global_canary,CANARY_SIZE)) {
      printf("*** Stack Smashing Detected *** : Canary Escaped - Oops!\n");
      exit(-1);
   }
   printf("Meow... Now Where's the Flag?\n");
   fflush(stdout);
}

int main(int argc, char **argv){
  setvbuf(stdout, NULL, _IONBF, 0);
  gid_t gid = getegid();
  setresgid(gid, gid, gid);
  read_canary();
  printf("       |\\__/,|   (`\\\n");
  printf("     _.|o o  |_   ) )\n");
  printf("----(((---(((--------\n");
  printf("Give a cat some string and lets see what happens: ");
  vuln();
  return 0;
}
